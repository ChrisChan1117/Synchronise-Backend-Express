'use strict';

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var _unirest = require('unirest');

var _unirest2 = _interopRequireDefault(_unirest);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _user = require('./user');

var _user2 = _interopRequireDefault(_user);

var _event = require('./event');

var _event2 = _interopRequireDefault(_event);

var _company = require('./company');

var _company2 = _interopRequireDefault(_company);

var _contact = require('./contact');

var _contact2 = _interopRequireDefault(_contact);

var _counts = require('./counts');

var _counts2 = _interopRequireDefault(_counts);

var _admin = require('./admin');

var _admin2 = _interopRequireDefault(_admin);

var _tag = require('./tag');

var _tag2 = _interopRequireDefault(_tag);

var _segment = require('./segment');

var _segment2 = _interopRequireDefault(_segment);

var _message = require('./message');

var _message2 = _interopRequireDefault(_message);

var _conversation = require('./conversation');

var _conversation2 = _interopRequireDefault(_conversation);

var _note = require('./note');

var _note2 = _interopRequireDefault(_note);

var Client = (function () {
  function Client() {
    _classCallCheck(this, Client);

    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    if (args.length === 2) {
      this.appId = args[0];
      this.appApiKey = args[1];
    } else if (args.length === 1) {
      this.appId = args[0].appId;
      this.appApiKey = args[0].appApiKey;
    }
    if (!this.appId || !this.appApiKey) {
      throw new Error('Could not construct a client with those parameters');
    }
    this.users = new _user2['default'](this);
    this.events = new _event2['default'](this);
    this.companies = new _company2['default'](this);
    this.contacts = new _contact2['default'](this);
    this.leads = new _contact2['default'](this);
    this.counts = new _counts2['default'](this);
    this.admins = new _admin2['default'](this);
    this.tags = new _tag2['default'](this);
    this.segments = new _segment2['default'](this);
    this.messages = new _message2['default'](this);
    this.conversations = new _conversation2['default'](this);
    this.notes = new _note2['default'](this);
    this.promises = false;
  }

  _createClass(Client, [{
    key: 'usePromises',
    value: function usePromises() {
      this.promises = true;
      return this;
    }
  }, {
    key: 'promiseProxy',
    value: function promiseProxy(f, req) {
      var _this = this;

      if (this.promises) {
        var _ret = (function () {
          var callbackHandler = _this.callback;
          return {
            v: new _bluebird2['default'](function (resolve, reject) {
              var resolver = function resolver(err, data) {
                if (err) {
                  reject(new Error(JSON.stringify(err)));
                } else {
                  resolve(data);
                }
              };
              req.end(function (r) {
                return callbackHandler(resolver, r);
              });
            })
          };
        })();

        if (typeof _ret === 'object') return _ret.v;
      } else {
        req.end(function (r) {
          return _this.callback(f, r);
        });
      }
    }
  }, {
    key: 'ping',
    value: function ping(f) {
      _unirest2['default'].get('https://api.intercom.io/admins').auth(this.appId, this.appApiKey).type('json').header('Accept', 'application/json').header('User-Agent', 'intercom-node-client/2.0.0').end(function (r) {
        return f(r.status);
      });
    }
  }, {
    key: 'put',
    value: function put(endpoint, data, f) {
      return this.promiseProxy(f, _unirest2['default'].put('https://api.intercom.io' + endpoint).auth(this.appId, this.appApiKey).type('json').send(data).header('Accept', 'application/json').header('User-Agent', 'intercom-node-client/2.0.0'));
    }
  }, {
    key: 'post',
    value: function post(endpoint, data, f) {
      return this.promiseProxy(f, _unirest2['default'].post('https://api.intercom.io' + endpoint).auth(this.appId, this.appApiKey).type('json').send(data).header('Accept', 'application/json').header('User-Agent', 'intercom-node-client/2.0.0'));
    }
  }, {
    key: 'get',
    value: function get(endpoint, data, f) {
      return this.promiseProxy(f, _unirest2['default'].get('https://api.intercom.io' + endpoint).auth(this.appId, this.appApiKey).type('json').query(data).header('Accept', 'application/json').header('User-Agent', 'intercom-node-client/2.0.0'));
    }
  }, {
    key: 'nextPage',
    value: function nextPage(paginationObject, f) {
      return this.promiseProxy(f, _unirest2['default'].get(paginationObject.next).auth(this.appId, this.appApiKey).type('json').header('Accept', 'application/json').header('User-Agent', 'intercom-node-client/2.0.0'));
    }
  }, {
    key: 'delete',
    value: function _delete(endpoint, data, f) {
      return this.promiseProxy(f, _unirest2['default']['delete']('https://api.intercom.io' + endpoint).auth(this.appId, this.appApiKey).type('json').query(data).header('Accept', 'application/json').header('User-Agent', 'intercom-node-client/2.0.0'));
    }
  }, {
    key: 'callback',
    value: function callback(f, data) {
      if (!f) {
        return;
      }
      if (f.length >= 2) {
        var hasErrors = data.error || data.body && data.body.type === 'error.list';
        if (hasErrors) {
          f(data, null);
        } else {
          f(null, data);
        }
      } else {
        f(data);
      }
    }
  }]);

  return Client;
})();

exports['default'] = Client;
module.exports = exports['default'];